<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Factura</title>
    <link rel="stylesheet" href="design/css/fact.css">
</head>
<body>
    <div class="container">
        <h1>Registro de Factura</h1>

        <form id="invoiceForm">
            <div class="form-group">
                <label for="customerType">Tipo de Cliente:</label>
                <select id="customerType" name="customerType" required>
                    <option value="">Seleccionar</option>
                    <option value="individuo">Individuo</option>
                    <option value="organizacion">Organización</option>
                </select>
            </div>
        
            <div id="individualFields" class="conditional-fields" style="display: none;">
                <div class="form-group">
                    <label for="name">Nombre del Cliente:</label>
                    <input type="text" id="name" name="name" placeholder="Nombre del Individuo">
                </div>
                <div class="form-group">
                    <label for="apellidos">Apellidos:</label>
                    <input type="text" id="apellidos" name="apellidos" placeholder="Apellido del Individuo">
                </div>
                <div class="form-group">
                    <label for="dni">RFC:</label>
                    <input type="text" id="dni" name="dni" placeholder="RFC del Cliente">
                </div>
            </div>
        
            <div id="organizationFields" class="conditional-fields" style="display: none;">
                <div class="form-group">
                    <label for="orgName">Nombre de la Organización:</label>
                    <input type="text" id="orgName" name="orgName" placeholder="Nombre de la Organización">
                </div>
                <div class="form-group">
                    <label for="taxId">RFC Persona Moral:</label>
                    <input type="text" id="taxId" name="taxId" placeholder="ID Tributario">
                </div>
            </div>
            <div id="commonFields" class="conditional-fields" style="display: none;">
                <div class="form-group">
                    <label for="cpostal">Código Postal:</label>
                    <input type="text" id="cpostal" name="cpostal" placeholder="Código de 5 digitos">
                </div>
                <div class="form-group">
                    <label for="email">Correo Electrónico:</label>
                    <input type="email" id="email" name="email" required placeholder="Correo del Cliente">
                </div>
            </div>            
        
            <div id="items">
                <h3>Elementos del Carrito</h3>
            </div>
        
            <div class="form-group total">
                <strong>Total: $<span id="totalAmount">0.00</span></strong>
            </div>
        
            <button type="button" id="generatePdf">Generar PDF</button>
            <button type="button" id="sendpdf">Enviar por correo</button>
        </form>        
    </div>

    <br>
    <br>
    <div class="cafecito">
    <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g id="study">
            <rect width="64" height="64"/>
            <g id="smoke">
            <path id="smoke-2" d="M9 21L9.55279 19.8944C9.83431 19.3314 9.83431 18.6686 9.55279 18.1056L9 17L8.44721 15.8944C8.16569 15.3314 8.16569 14.6686 8.44721 14.1056L9 13" stroke="#797270"/>
            <path id="smoke-1" d="M6.5 22L7.05279 20.8944C7.33431 20.3314 7.33431 19.6686 7.05279 19.1056L6.5 18L5.94721 16.8944C5.66569 16.3314 5.66569 15.6686 5.94721 15.1056L6.5 14" stroke="#797270"/>
            </g>
            <g id="laptop">
            <rect id="laptop-base" x="17" y="28" width="20" height="3" fill="#F3F3F3" stroke="#453F3C" stroke-width="2"/>
            <rect id="laptop-screen" x="18" y="17" width="18" height="11" fill="#5A524E" stroke="#453F3C" stroke-width="2"/>
            <rect id="line-1" x="20" y="19" width="14" height="1" fill="#F78764"/>
            <rect id="line-2" x="20" y="21" width="14" height="1" fill="#F9AB82"/>
            <rect id="line-3" x="20" y="23" width="14" height="1" fill="#F78764"/>
            <rect id="line-4" x="20" y="25" width="14" height="1" fill="#F9AB82"/>
            </g>
            <g id="cup">
            <rect id="Rectangle 978" x="5" y="24" width="5" height="7" fill="#CCC4C4" stroke="#453F3C" stroke-width="2"/>
            <path id="Ellipse 416" d="M11 28C12.1046 28 13 27.1046 13 26C13 24.8954 12.1046 24 11 24" stroke="#453F3C" stroke-width="2"/>
            <rect id="Rectangle 996" x="6" y="25" width="3" height="1" fill="#D6D2D1"/>
            </g>
            <g id="books">
            <rect id="Rectangle 984" x="58" y="27" width="4" height="14" transform="rotate(90 58 27)" fill="#B16B4F" stroke="#453F3C" stroke-width="2"/>
            <rect id="Rectangle 985" x="56" y="23" width="4" height="14" transform="rotate(90 56 23)" fill="#797270" stroke="#453F3C" stroke-width="2"/>
            <rect id="Rectangle 986" x="60" y="19" width="4" height="14" transform="rotate(90 60 19)" fill="#F78764" stroke="#453F3C" stroke-width="2"/>
            <rect id="Rectangle 993" x="47" y="20" width="12" height="1" fill="#F9AB82"/>
            <rect id="Rectangle 994" x="43" y="24" width="12" height="1" fill="#54504E"/>
            <rect id="Rectangle 995" x="45" y="28" width="12" height="1" fill="#804D39"/>
            </g>
            <g id="desk">
            <rect id="Rectangle 973" x="4" y="31" width="56" height="5" fill="#797270" stroke="#453F3C" stroke-width="2"/>
            <rect id="Rectangle 987" x="10" y="36" width="30" height="6" fill="#797270" stroke="#453F3C" stroke-width="2"/>
            <rect id="Rectangle 975" x="6" y="36" width="4" height="24" fill="#797270" stroke="#453F3C" stroke-width="2"/>
            <rect id="Rectangle 974" x="40" y="36" width="18" height="24" fill="#797270" stroke="#453F3C" stroke-width="2"/>
            <line id="Line 129" x1="40" y1="48" x2="58" y2="48" stroke="#453F3C" stroke-width="2"/>
            <line id="Line 130" x1="22" y1="39" x2="28" y2="39" stroke="#453F3C" stroke-width="2"/>
            <line id="Line 142" x1="46" y1="42" x2="52" y2="42" stroke="#453F3C" stroke-width="2"/>
            <line id="Line 131" x1="46" y1="54" x2="52" y2="54" stroke="#453F3C" stroke-width="2"/>
            <rect id="Rectangle 988" x="11" y="37" width="28" height="1" fill="#54504E"/>
            <rect id="Rectangle 992" x="5" y="32" width="54" height="1" fill="#9E9492"/>
            <rect id="Rectangle 989" x="7" y="37" width="2" height="1" fill="#54504E"/>
            <rect id="Rectangle 990" x="41" y="37" width="16" height="1" fill="#54504E"/>
            <rect id="Rectangle 991" x="41" y="49" width="16" height="1" fill="#54504E"/>
            <line id="Line 143" y1="60" x2="64" y2="60" stroke="#453F3C" stroke-width="2"/>
            </g>
            </g>
        </svg>
    </div>
    
    

    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
    </script>
    <script type="text/javascript">
    (function(){
        emailjs.init("JkWwo4bV0ZEyjS9C6"); 
    })();
    
    // Variables definidas
    const senderPdf = document.getElementById('sendpdf');
    const totalAmount = document.getElementById('totalAmount');
    const itemsContainer = document.getElementById('items');
    const customerType = document.getElementById('customerType');
    // ID de servicio y plantilla
    const serviceID = 'service_m354r3d0nd4';
    const templateID = 'template_zoukpyn';
    // Recupera los items de carrito
    const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    cargarProductos(carrito);

    function cargarProductos(carrito) {
        let total = 0;
        carrito.forEach(item => {
            const productRow = document.createElement('div');
            productRow.classList.add('item');
            productRow.innerHTML = `
                <span>${item.producto} (x${item.cantidad})</span>
                <span>$${item.precio * item.cantidad} MXN</span>
            `;
            itemsContainer.appendChild(productRow);
            total += item.precio * item.cantidad;
        });
        totalAmount.textContent = total.toFixed(2);
    }
    // En el botón de enviar correo hace lo siguiente
    senderPdf.addEventListener('click', () => {
        event.preventDefault(); // Evita que se recargue la página

        const customerData = customerType.value === 'individuo'
            ? {
                type: 'Individuo',
                name: document.getElementById('name').value,
                apellidos: document.getElementById('apellidos').value,
                dni: document.getElementById('dni').value
            }
            : {
                type: 'Organización',
                name: document.getElementById('orgName').value,
                taxId: document.getElementById('taxId').value
            };

        const postalCode = document.getElementById('cpostal').value;
        const email = document.getElementById('email').value;
        
        // Generamos una variable para mandarlo como mensaje comenzando con el tipo de cliente
        let text = `Tipo de Cliente: ${customerData.type}\n`;
        // Acá revisamos los rfc
        if (customerData.dni || customerData.taxId) {
            text += `RFC: ${customerData.dni || customerData.taxId}\nCódigo Postal: ${postalCode}\n`;
        }

        text += "A continuación se muestra un resumen de la compra:\n";

        // Por cada item dentro del carrito lo mete en el mensaje
        carrito.forEach((item, index) => {
            text += `${index + 1}. ${item.producto} - Cantidad: ${item.cantidad} - $${item.precio * item.cantidad} MXN\n`;
        });

        // Total
        text += `Total: $${totalAmount.textContent} MXN`;
        // Aquí generé el número de transacción
        const trans = Array.from({ length: 10 }, () => Math.floor(Math.random() * 10)).join('');
        // Luego remplazar por nuestro número de cuenta o paypal donde depositar
        const noCuenta = "1234 5678 1234 5678";

        text += `\n\tNúmero de transacción: ${trans}\n\tRealizar pago a número de cuenta: ${noCuenta}`;

        const pdfNombre = `${customerData.name} ${customerData.apellidos}`;

        // Esto de aquí hace la mágia como que no 🔥
        emailjs.send(serviceID, templateID, {
            user_name: pdfNombre,
            user_email: email,
            message: text
        })
        .then(response => {
            console.log("Correo enviado exitosamente", response.status, response.text);
        })
        .catch(error => {
            console.error("Hubo un error al enviar el correo", error);
        });
    });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="javascript/datos.js"></script>
</body>
</html>